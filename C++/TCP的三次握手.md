## TCP的三次握手   
为了准确无误地将数据送达目标处，TCP协议采用了三次握手（three-way handshaking）策略。    
用TCP协议把数据包送出去后，TCP不会对传送后的情况置之不理，它一定会向对方确认是否成功送达。握手过程中使用了TCP的标志（flag）——SYN（synchronize）和ACK（acknowledgement）。    
> TCP，提供面向连接的服务，在传送数据之前必须先建立连接，数据传送完成后要释放连接。因此TCP是一种可靠的的运输服务，正因为这样，会增加许多的开销，比如确认，流量控制等。对应的应用层的协议主要有 SMTP,TELNET,HTTP,FTP等。   
> 而UDP，在传送数据前不需要先建立连接，远地的主机在收到UDP报文后也不需要给出任何确认。虽然UDP不提供可靠交付，但是正是因为这样，省去和很多的开销，使得它的速度比较快，比如一些对实时性要求较高的服务，就常常使用的是UDP。对应的应用层的协议主要有DNS,TFTP,DHCP,SNMP,NFS 等。   
### 三次握手的最简描述
**发送端（客户端）首先发送一个带SYN标志的数据包给对方。   
接收端（服务器端）收到后，回传一个带有SYN/ACK标志的数据包以示传达确认信息。    
最后，发送端再回传一个带ACK标志的数据包，代表“握手”结束。**    
若在握手过程中某个阶段莫名中断，TCP协议会再次以相同的顺序发送相同的数据包。    
### 三次握手详述
1 TCP服务器进程先创建传输控制块TCB，时刻准备接受客户进程的连接请求，此时服务器就进入了LISTEN（监听）状态。   
> 第一次握手，客户端发送syn包给服务器端。      
   
**2 TCP客户进程也是先创建传输控制块TCB，然后向服务器发出连接请求报文，这时候报文首部中的同部位SYN=1，同时选择一个初始序列号 seq=x ，此时TCP客户端进程进入了SYN-SENT（同步已发送状态）状态。TCP规定，SYN报文段（SYN=1的报文段）不能携带数据，但需要消耗掉一个序号。**    
> 第二次握手，服务器段返回ack+syn包给客户端。   
   
**3 TCP服务器收到请求报文后，如果同意连接，则发出确认报文。确认报文中应该 ACK=1，SYN=1，确认号是ack=x+1，同时也要为自己初始化一个序列号 seq=y，此时，TCP服务器进程进入了SYN-RCVD（同步收到）状态。这个报文也不能携带数据，但是同样要消耗一个序号。**   
> 第三次握手，客户端向服务器端发送确认包ack包。   

**4 TCP客户进程收到确认后，还要向服务器给出确认。确认报文的ACK=1，ack=y+1，自己的序列号seq=x+1，此时，TCP连接建立，客户端进入ESTABLISHED（已建立连接）状态。TCP规定，ACK报文段可以携带数据，但是如果不携带数据则不消耗序号。**   
5 当服务器收到客户端的确认后也进入ESTABLISHED状态，此后双方就可以开始通信了。    
![](https://github.com/sii2017/image/blob/master/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png)   
### 相关问题
#### Q1 为什么TCP客户端最后还要发送一次确认呢？   
主要防止已经失效的连接请求报文突然又传送到了服务器，从而产生错误。   
如果使用的是两次握手建立连接，假设有这样一种场景，客户端发送了第一个请求连接并且没有丢失，只是因为在网络结点中滞留的时间太长了，由于TCP的客户端迟迟没有收到确认报文，以为服务器没有收到，此时重新向服务器发送这条报文，此后客户端和服务器经过两次握手完成连接，传输数据，然后关闭连接。此时此前滞留的那一次请求连接，网络通畅了到达了服务器，这个报文本该是失效的，但是，两次握手的机制将会让客户端和服务器再次建立连接，这将导致不必要的错误和资源的浪费。    
如果采用的是三次握手，就算是那一次失效的报文传送过来了，服务端接受到了那条失效报文并且回复了确认报文，但是客户端不会再次发出确认。由于服务器收不到确认，就知道客户端并没有请求连接。    
#### Q2 为什么要三次握手？     
三次握手的目的是建立可靠的通信信道，说到通讯，简单来说就是数据的发送与接收，而三次握手最主要的目的就是双方确认自己与对方的发送与接收机能正常。    
第一次握手：Client什么都不能确认；Server确认了对方发送正常。    
第二次握手：Client确认了：自己发送、接收正常，对方发送、接收正常；Server确认了：自己接收正常，对方发送正常。    
第三次握手：Client确认了：自己发送、接收正常，对方发送、接收正常；Server确认了：自己发送、接收正常，对方发送接收正常。   
所以三次握手就能确认双发收发功能都正常，缺一不可。   
#### Q3 为什么要发送特定的数据包？      
三次握手的另外一个目的就是确认双方都支持TCP，告知对方用TCP传输。    
第一次握手：Server 猜测Client可能要建立TCP请求，但不确定，因为也可能是Client乱发了一个数据包给自己。   
第二次握手：通过ack=x+1，Client知道Server是支持TCP的，且理解了自己要建立TCP连接的意图。    
第三次握手：通过ack=y+1，Server知道Client是支持TCP的，且确实是要建立TCP连接。    